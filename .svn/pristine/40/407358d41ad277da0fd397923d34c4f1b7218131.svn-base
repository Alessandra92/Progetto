package controllo;

import java.io.IOException;
import java.sql.SQLException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.GregorianCalendar;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import modello.Paziente;
import persistenza.dao.DAOCitta;
import persistenza.dao.DAOPaziente;
import utilita.Verifica;

/**
 * Servlet implementation class ModificaPaziente
 */
@WebServlet("/ModificaDati")
public class ModificaDati extends HttpServlet {
	private static final long serialVersionUID = 1L;
       
    /**
     * @see HttpServlet#HttpServlet()
     */
    public ModificaDati() {
        super();
        // TODO Auto-generated constructor stub
    }

	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		if(request.getSession().getAttribute("id") == null){
			
			RequestDispatcher rd = request.getRequestDispatcher("login.jsp");
			rd.forward(request, response);
			}
		else {
			request.setAttribute("listaCitta", DAOCitta.getAll());
		    
		    Paziente paziente = DAOPaziente.getPazienteById(Integer.parseInt(request.getSession().getAttribute("id").toString()));
			paziente.setPassword(null);

			System.out.println(paziente);

			request.setAttribute("paziente", paziente);
			RequestDispatcher rd = request.getRequestDispatcher("modificaDati.jsp");
			rd.forward(request, response);
			
		}
		
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		int check = 0;
		
		Calendar calendar= Calendar.getInstance();
		if(request.getSession().getAttribute("id") == null){
			RequestDispatcher rd = request.getRequestDispatcher("login.jsp");
			rd.forward(request, response);
			} 
		else {
			Paziente paziente = new Paziente();
			paziente.setIdPaziente(Integer.parseInt(request.getSession().getAttribute("id").toString()));
			paziente.setNome(request.getParameter("nome"));
			paziente.setCognome(request.getParameter("cognome"));
			SimpleDateFormat sdf = new SimpleDateFormat("dd-MMM-yyyy");
		try {
			calendar.setTime(sdf.parse(request.getParameter("dataNascita")));
		} catch (ParseException e1) {
			e1.printStackTrace();
		}
		paziente.setDataNas(calendar);
		paziente.setIdCitta(Integer.parseInt(request.getParameter("idCitta")));
		paziente.setSesso((request.getParameter("sesso")));
		paziente.setCf(request.getParameter("cf"));
		paziente.setIndirizzo(request.getParameter("indirizzo"));
		boolean[] errore = Verifica.verificaPazienteParziale(paziente);
		

		if(errore[0]== true){	
			request.getSession().setAttribute("errore", errore);
			request.getSession().setAttribute("paziente", paziente);
			RequestDispatcher rd = request.getRequestDispatcher("modificaDati.jsp");
			rd.forward(request, response);
		}
		else {

			try {
			 check = DAOPaziente.cambiaDati(paziente);
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			if(check == 0){	
				request.getSession().setAttribute("paziente", paziente);
				RequestDispatcher rd = request.getRequestDispatcher("modificaDati.jsp");
				rd.forward(request, response);
			} else {
			RequestDispatcher rd = request.getRequestDispatcher("homePageUtente.jsp");
			rd.forward(request, response);
		}
		}
		}
	}
	
}
